<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì›¹ìº  ë§ì¶¤ ë·°ì–´</title>
<style>
  :root{--bg:#0b0d10;--fg:#e7ebef;--muted:#a7b0ba;--card:#141a20}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui}
  header{padding:14px 18px;border-bottom:1px solid #1f252d;background:#0f141a;
         display:flex;gap:12px;align-items:center;justify-content:space-between}
  header a{color:#cfe3ff;text-decoration:none}
  .btn{cursor:pointer;border:none;background:#1b2530;color:#dfe7ef;border:1px solid #2b3947;border-radius:10px;padding:8px 12px}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  /* ê°€ìš´ë° ì •ë ¬ ë ˆì´ì•„ì›ƒ */
  main{padding:18px;display:flex;flex-direction:column;align-items:center;gap:16px}
  .stage{position:relative;line-height:0;width:min(1100px,95vw);margin:0 auto}
  canvas{width:100%;height:auto;display:block;border-radius:12px;background:#10151b;transition:opacity .15s}
  #cam{position:absolute;display:none;object-fit:cover;border:none;border-radius:0;box-shadow:none;pointer-events:none;
       transform:translateZ(0);will-change:left,top,width,height}
  /* ì´¬ì˜ëœ ê²°ê³¼ë¥¼ í…œí”Œë¦¿ ìë¦¬ì— ë®ì–´ì”Œìš°ëŠ” ì „ìš© IMG */
  #shot{position:absolute;inset:0;display:none;width:100%;height:100%;object-fit:contain;border-radius:12px;z-index:4}

  .panel{background:var(--card);border:1px solid #222b36;border-radius:14px;padding:12px;width:min(1100px,95vw)}
  .hint{font-size:13px;color:var(--muted)}

  /* ì„¤ì • íŒ¨ë„(í† ê¸€) */
  .controls{display:none;margin-top:8px}
  .controls.show{display:block}
  .controls label{display:flex;justify-content:space-between;color:var(--muted);margin:8px 0}
  .controls input[type=range]{width:100%}

  /* ì´ë©”ì¼ ì…ë ¥ í–‰ */
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{flex:1;min-width:240px;padding:8px 10px;border:1px solid #2b3947;border-radius:10px;background:#0f141a;color:#e7ebef}

  /* ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ */
  .countdown{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
             background:rgba(0,0,0,.35);border-radius:12px;z-index:5}
  .countdown.show{display:flex}
  .countnum{font-size:10vw;line-height:1;font-weight:800;text-shadow:0 6px 24px rgba(0,0,0,.6)}
</style>
</head>
<body>
<header>
  <div class="left">
    <a href="/">â† ëª©ë¡</a>
    <strong id="title" style="margin-left:8px">ì›¹ìº  ë§ì¶¤ ë·°ì–´</strong>
  </div>
  <div class="right">
    <button id="btnShoot" class="btn">ğŸ“¸ ì´¬ì˜(3ì´ˆ)</button>
    <button id="btnSettings" class="btn" title="ì„¤ì •">âš™ï¸</button>
  </div>
</header>

<main>
  <!-- í…œí”Œë¦¿ì„ í˜ì´ì§€ ê°€ìš´ë°ì— -->
  <section class="stage" id="stage">
    <canvas id="cv"></canvas>
    <video id="cam" autoplay muted playsinline></video>

    <!-- ì´¬ì˜ ê²°ê³¼(í•©ì„±ë³¸)ë¥¼ í…œí”Œë¦¿ ìë¦¬ì— ì„ì‹œë¡œ í‘œì‹œ -->
    <img id="shot" alt="ì´¬ì˜ ê²°ê³¼">

    <!-- ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë²„ë ˆì´ -->
    <div id="countdown" class="countdown" aria-hidden="true">
      <div id="countnum" class="countnum">3</div>
    </div>
  </section>

  <!-- ì„¤ì •(í•„ìš”í•  ë•Œë§Œ ì—´ê¸°) -->
  <section class="panel">
    <div class="controls" id="controls">
      <label>í°ìƒ‰ í—ˆìš©ì¹˜ <output id="tolOut">20</output></label>
      <input id="tol" type="range" min="10" max="60" value="20" step="1" oninput="tolOut.textContent=this.value; detectBox();">
      <label>íƒìƒ‰ ìƒë‹¨ ë†’ì´(px) <output id="topOut">420</output></label>
      <input id="top" type="range" min="120" max="1600" value="420" step="10" oninput="topOut.textContent=this.value; detectBox();">
      <label>ìµœì†Œë©´ì (pxÂ²) <output id="areaOut">4000</output></label>
      <input id="area" type="range" min="500" max="60000" value="4000" step="500" oninput="areaOut.textContent=this.value; detectBox();">
      <label>Bleed(ê²¹ì¹¨, px) <output id="bleedOut">4</output></label>
      <input id="bleed" type="range" min="0" max="24" value="4" step="1" oninput="bleedOut.textContent=this.value; positionCam();">
      <p class="hint">Bleedë¥¼ ì˜¬ë¦¬ë©´ ë¹„ë””ì˜¤ê°€ ë°•ìŠ¤ë³´ë‹¤ ì¡°ê¸ˆ ì»¤ì ¸ ê²½ê³„/ì—¬ë°±ì´ ì „í˜€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </div>
    <p class="hint">í•„ìš” ì‹œ âš™ï¸ ë²„íŠ¼ìœ¼ë¡œ ì„¤ì •ì„ ì—´ì–´ ì„¸ë¶€ ì¡°ì •í•˜ì„¸ìš”.</p>
  </section>

  <!-- ì´ë©”ì¼ ì…ë ¥ + ì „ì†¡ -->
  <section class="panel" style="display:flex;flex-direction:column;gap:10px">
    <div class="row">
      <input id="email" class="input" type="email" placeholder="ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼(ì˜ˆ: user@example.com)">
      <button id="btnEmail" class="btn" disabled>âœ‰ï¸ ì´ë©”ì¼ë¡œ ì „ì†¡</button>
    </div>
    <span id="status" class="hint"></span>
  </section>
</main>

<script>
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const vid = document.getElementById('cam');
const shot = document.getElementById('shot');       // í…œí”Œë¦¿ ìë¦¬ ì„ì‹œ ì´ë¯¸ì§€
const titleEl = document.getElementById('title');
const controls = document.getElementById('controls');
const btnSettings = document.getElementById('btnSettings');
const btnShoot = document.getElementById('btnShoot');
const btnEmail = document.getElementById('btnEmail');
const emailInput = document.getElementById('email');
const statusEl = document.getElementById('status');

const countdownEl = document.getElementById('countdown');
const countnumEl = document.getElementById('countnum');

let imgBitmap=null, box=null, lastMergedDataURL=null, showingShot=false;

// ì„¤ì • í† ê¸€
btnSettings.addEventListener('click', ()=> controls.classList.toggle('show'));

// ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬ & ë²„íŠ¼ í™œì„±í™”
emailInput.addEventListener('input', enableSendIfReady);
function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
function enableSendIfReady(){
  btnEmail.disabled = !(lastMergedDataURL && isValidEmail(emailInput.value));
}

// í…œí”Œë¦¿ ë¡œë“œ
const params = new URLSearchParams(location.search);
const IMG = params.get('img');
if(!IMG){ alert('ì´ë¯¸ì§€ íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤. /viewer?img=/templates/íŒŒì¼.png'); }
else { titleEl.textContent = `ì›¹ìº  ë§ì¶¤ ë·°ì–´ â€“ ${decodeURIComponent(IMG.split('/').pop())}`; loadImage(IMG); startCam(); }

// ë°˜ì‘í˜• ì¬ë°°ì¹˜
window.addEventListener('resize', positionCam, {passive:true});
document.addEventListener('scroll', positionCam, {passive:true});

// ì´ë¯¸ì§€ ë¡œë“œ
async function loadImage(src){
  const img = await createImageBitmap(await (await fetch(src)).blob());
  imgBitmap = img;
  cv.width = img.width;
  cv.height = img.height;
  drawImage();
  detectBox();
}
function drawImage(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.drawImage(imgBitmap,0,0);
}

// í° ë°•ìŠ¤ íƒì§€
function detectBox(){
  if(!imgBitmap) return;
  const tol = +document.getElementById('tol').value;
  const topLimit = +document.getElementById('top').value;
  const minArea = +document.getElementById('area').value;

  const w=cv.width,h=cv.height,searchH=Math.min(topLimit,h);
  const img=ctx.getImageData(0,0,w,searchH);
  const d=img.data;

  const visited=new Uint8Array(w*searchH);
  const idx=(x,y)=>y*w+x;
  const isWhite=(r,g,b)=>r>=255-tol && g>=255-tol && b>=255-tol;
  const getRGB=(x,y)=>{const i=(y*w+x)*4;return[d[i],d[i+1],d[i+2]];}

  const comps=[]; const qx=new Int32Array(w*searchH), qy=new Int32Array(w*searchH);

  for(let y=0;y<searchH;y++){
    for(let x=0;x<w;x++){
      const p=idx(x,y); if(visited[p]) continue;
      const [r,g,b]=getRGB(x,y);
      if(!isWhite(r,g,b)){ visited[p]=1; continue; }

      let head=0,tail=0; qx[tail]=x; qy[tail]=y; tail++; visited[p]=1;
      let minX=x,maxX=x,minY=y,maxY=y,area=0;

      while(head<tail){
        const cx=qx[head], cy=qy[head]; head++; area++;
        if(cx<minX)minX=cx;if(cx>maxX)maxX=cx;
        if(cy<minY)minY=cy;if(cy>maxY)maxY=cy;

        for(const [nx,ny] of [[cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]]){
          if(nx<0||ny<0||nx>=w||ny>=searchH) continue;
          const pi=idx(nx,ny); if(visited[pi]) continue;
          const [rr,gg,bb]=getRGB(nx,ny);
          if(!isWhite(rr,gg,bb)){ visited[pi]=1; continue; }
          visited[pi]=1; qx[tail]=nx; qy[tail]=ny; tail++;
        }
      }
      if(area>=minArea) comps.push({minX,minY,maxX,maxY,area});
    }
  }

  if(comps.length===0){ alert('í° ë°•ìŠ¤ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í—ˆìš©ì¹˜/íƒìƒ‰ë†’ì´/ìµœì†Œë©´ì  ì¡°ì •'); return; }
  comps.sort((a,b)=>b.area-a.area);
  box = comps[0];
  drawImage();
  positionCam();
}

// ì›¹ìº  ì‹œì‘
async function startCam(){
  if(vid.srcObject) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    vid.srcObject = stream;
  }catch(e){
    console.error(e); alert('ì›¹ìº  ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  }
}

// ë¹„ë””ì˜¤ë¥¼ ë°•ìŠ¤ì— ë§ì¶¤
function positionCam(){
  if(!box) return;
  const bleed = +document.getElementById('bleed').value;
  const scaleX = cv.clientWidth / cv.width;
  const scaleY = cv.clientHeight / cv.height;

  const left   = box.minX*scaleX - bleed;
  const top    = box.minY*scaleY - bleed;
  const width  = (box.maxX-box.minX)*scaleX + 2*bleed;
  const height = (box.maxY-box.minY)*scaleY + 2*bleed;

  vid.style.display = showingShot ? 'none' : 'block';
  vid.style.left = left + 'px';
  vid.style.top = top + 'px';
  vid.style.width = width + 'px';
  vid.style.height = height + 'px';
  vid.style.objectFit = 'cover';
}

/* ---------- ì¹´ìš´íŠ¸ë‹¤ìš´ ìœ í‹¸ ---------- */
const sleep = ms => new Promise(r=>setTimeout(r, ms));
async function runCountdown(seconds=3){
  countdownEl.classList.add('show');
  for(let t=seconds; t>=1; t--){
    countnumEl.textContent = t;
    await sleep(1000);
  }
  countdownEl.classList.remove('show');
}

/* ---------- ì´¬ì˜(= í•©ì„± ìƒì„±) ---------- */
btnShoot.addEventListener('click', async ()=>{
  if(!imgBitmap || !box || !vid.videoWidth){ alert('ì´ë¯¸ì§€/ì›¹ìº /ë°•ìŠ¤ íƒì§€ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
  btnShoot.disabled = true; statusEl.textContent = 'ì´¬ì˜ ì¤€ë¹„...';
  await runCountdown(3); // 3ì´ˆ

  // ì›ë³¸ ì¢Œí‘œê³„ì—ì„œ í•©ì„±
  const bleedCss = +document.getElementById('bleed').value;
  const scaleX = cv.clientWidth / cv.width;
  const scaleY = cv.clientHeight / cv.height;
  const bleedX = bleedCss / (scaleX || 1);
  const bleedY = bleedCss / (scaleY || 1);

  const dx = Math.max(0, Math.floor(box.minX - bleedX));
  const dy = Math.max(0, Math.floor(box.minY - bleedY));
  const dw = Math.min(cv.width - dx, Math.floor((box.maxX - box.minX) + 2*bleedX));
  const dh = Math.min(cv.height - dy, Math.floor((box.maxY - box.minY) + 2*bleedY));

  const out = document.createElement('canvas');
  out.width = cv.width;
  out.height = cv.height;
  const octx = out.getContext('2d');
  octx.drawImage(imgBitmap, 0, 0);        // í…œí”Œë¦¿
  octx.drawImage(vid, dx, dy, dw, dh);    // ì›¹ìº 

  lastMergedDataURL = out.toDataURL('image/png');

  // â–¼ í…œí”Œë¦¿ ì˜ì—­ì— í•©ì„±ë³¸ì„ ì ì‹œ ë®ì–´ì”Œì›€
  shot.src = lastMergedDataURL;
  shot.style.display = 'block';
  cv.style.opacity = '0';       // ë ˆì´ì•„ì›ƒ ìœ ì§€í•˜ë©´ì„œ ìˆ¨ê¹€(ë†’ì´ ìœ ì§€)
  showingShot = true;
  positionCam();                // ë¹„ë””ì˜¤ëŠ” ìë™ìœ¼ë¡œ ìˆ¨ê¹€
  enableSendIfReady();
  statusEl.textContent = 'ì´¬ì˜ ì™„ë£Œ! ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ê³  ì „ì†¡í•˜ì„¸ìš”.';
  btnShoot.disabled = false;
});

/* ---------- ì´ë©”ì¼ë¡œ ì „ì†¡(ì „ì†¡ í›„ ì›ë˜ í™”ë©´ìœ¼ë¡œ ë³µê·€) ---------- */
btnEmail.addEventListener('click', async ()=>{
  if(!lastMergedDataURL){ alert('ë¨¼ì € "ì´¬ì˜(3ì´ˆ)"ì„ ëˆŒëŸ¬ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.'); return; }
  if(!isValidEmail(emailInput.value)){ alert('ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }

  btnEmail.disabled = true;
  statusEl.textContent = 'ì´ë©”ì¼ ì „ì†¡ ì¤‘...';

  try {
    const filename = `merged_${Date.now()}.png`;
    const res = await fetch('/api/send-email', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        to: emailInput.value,
        filename,
        subject: 'ì‹ ë¬¸ í…œí”Œë¦¿ í•©ì„± ì´ë¯¸ì§€',
        text: 'í•©ì„±ëœ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•©ë‹ˆë‹¤.',
        imageBase64: lastMergedDataURL
      })
    });

    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      const json = await res.json();
      if(!res.ok) throw new Error(json.error || 'ì „ì†¡ ì‹¤íŒ¨');

      statusEl.textContent = 'ì „ì†¡ ì™„ë£Œ! ë°›ì€í¸ì§€í•¨ì„ í™•ì¸í•˜ì„¸ìš”. í™”ë©´ì„ ë³µêµ¬í•©ë‹ˆë‹¤.';
      // â–² ì „ì†¡ ì„±ê³µ â†’ ì›ë˜ í…œí”Œë¦¿+ì›¹ìº  í™”ë©´ìœ¼ë¡œ ë³µê·€
      restoreLiveView();
    } else {
      const text = await res.text();
      throw new Error(`ì„œë²„ê°€ JSONì´ ì•„ë‹Œ ì‘ë‹µì„ ëŒë ¤ì¤Œ: ${text.slice(0,120)}â€¦`);
    }
  } catch (e) {
    statusEl.textContent = 'ì „ì†¡ ì˜¤ë¥˜: ' + e.message;
    console.error(e);
  } finally {
    btnEmail.disabled = false;
  }
});

function restoreLiveView(){
  // í…œí”Œë¦¿ ìë¦¬ì— ìˆë˜ ì´¬ì˜ë³¸ ê°ì¶”ê¸°
  shot.style.display = 'none';
  showingShot = false;

  // ìº”ë²„ìŠ¤/ì›¹ìº  ë³µê·€
  cv.style.opacity = '1';
  positionCam();

  // ì „ì†¡ í›„ì—ëŠ” ìƒˆ ì´¬ì˜ì„ ìœ ë„í•˜ë„ë¡ ìƒíƒœ ì´ˆê¸°í™”
  lastMergedDataURL = null;
  enableSendIfReady();
}
</script>
</body>
</html>
